<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CashBack Pro - Earn While You Shop</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .balance {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: bold;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .auth-section {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 2rem auto;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.7rem;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #007bff;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .dashboard-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .dashboard-card h3 {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .dashboard-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }

        .filters {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin: 2rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filters-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-input, .category-select {
            padding: 0.7rem;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 1rem;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
        }

        .stores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .store-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .store-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #007bff;
        }

        .store-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .store-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
            border-radius: 8px;
            margin-right: 1rem;
        }

        .store-info h3 {
            margin-bottom: 0.25rem;
            color: #333;
        }

        .store-category {
            color: #666;
            font-size: 0.8rem;
            text-transform: uppercase;
            background: #f8f9fa;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
        }

        .store-description {
            color: #666;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .cashback-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .cashback-rate {
            font-size: 1.2rem;
            font-weight: bold;
            color: #28a745;
        }

        .commission-rate {
            font-size: 0.8rem;
            color: #666;
        }

        .alert {
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .hidden {
            display: none !important;
        }

        .recent-activity {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 2rem 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-logo {
            width: 30px;
            height: 30px;
            object-fit: contain;
            margin-right: 1rem;
            border-radius: 4px;
        }

        .activity-details {
            flex: 1;
        }

        .activity-time {
            color: #666;
            font-size: 0.8rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .filters-row {
                flex-direction: column;
            }
            
            .search-input {
                min-width: auto;
            }
            
            .stores-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .error-message {
            color: #dc3545;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .success-message {
            color: #28a745;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <div id="app">
        <header id="main-header" class="hidden">
            <div class="container">
                <div class="header-content">
                    <div class="logo">💰 CashBack Pro</div>
                    <div class="user-info">
                        <div class="balance">Balance: ₹<span id="user-balance">0.00</span></div>
                        <span id="user-email"></span>
                        <button class="btn btn-secondary" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Authentication Section -->
        <div id="auth-section" class="container">
            <div class="auth-section">
                <h2 id="auth-title">Welcome to CashBack Pro</h2>
                <p style="text-align: center; margin-bottom: 2rem; color: #666;">
                    Earn cashback on every purchase from your favorite stores
                </p>
                
                <div id="login-form">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="login-email" placeholder="Enter your email">
                        <div class="error-message" id="login-email-error"></div>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="login-password" placeholder="Enter your password">
                        <div class="error-message" id="login-password-error"></div>
                    </div>
                    <button class="btn" style="width: 100%; margin-bottom: 1rem;" onclick="login()">
                        Login
                    </button>
                    <p style="text-align: center;">
                        Don't have an account? 
                        <a href="#" onclick="showRegisterForm()" style="color: #007bff;">Sign up</a>
                    </p>
                </div>

                <div id="register-form" class="hidden">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="register-name" placeholder="Enter your full name">
                        <div class="error-message" id="register-name-error"></div>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="register-email" placeholder="Enter your email">
                        <div class="error-message" id="register-email-error"></div>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="register-password" placeholder="Create a password (min 6 chars)">
                        <div class="error-message" id="register-password-error"></div>
                    </div>
                    <div class="form-group">
                        <label>Referral Code (Optional)</label>
                        <input type="text" id="register-referral" placeholder="Enter referral code if you have one">
                    </div>
                    <button class="btn" style="width: 100%; margin-bottom: 1rem;" onclick="register()">
                        Create Account
                    </button>
                    <p style="text-align: center;">
                        Already have an account? 
                        <a href="#" onclick="showLoginForm()" style="color: #007bff;">Sign in</a>
                    </p>
                </div>

                <div id="auth-message"></div>
            </div>
        </div>

        <!-- Main App Section -->
        <div id="main-section" class="container hidden">
            <!-- Dashboard -->
            <div class="dashboard">
                <div class="dashboard-card">
                    <h3>Total Balance</h3>
                    <div class="value">₹<span id="dashboard-balance">0.00</span></div>
                </div>
                <div class="dashboard-card">
                    <h3>Total Earned</h3>
                    <div class="value">₹<span id="dashboard-earned">0.00</span></div>
                </div>
                <div class="dashboard-card">
                    <h3>Stores Visited</h3>
                    <div class="value" id="dashboard-stores">0</div>
                </div>
                <div class="dashboard-card">
                    <h3>Total Clicks</h3>
                    <div class="value" id="dashboard-clicks">0</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="filters-row">
                    <input type="text" class="search-input" id="store-search" placeholder="Search stores..." onkeyup="filterStores()">
                    <select class="category-select" id="category-filter" onchange="filterStores()">
                        <option value="all">All Categories</option>
                    </select>
                    <button class="btn" onclick="loadStores()">Refresh</button>
                </div>
            </div>

            <!-- Stores Grid -->
            <div class="loading" id="stores-loading">Loading stores...</div>
            <div class="stores-grid" id="stores-container"></div>

            <!-- Recent Activity -->
            <div class="recent-activity" id="recent-activity">
                <h3 style="margin-bottom: 1rem;">Recent Activity</h3>
                <div id="recent-clicks"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');
        let allStores = [];
        let categories = [];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            if (authToken) {
                showMainApp();
                loadDashboard();
                loadStores();
                loadCategories();
            } else {
                showAuthSection();
            }
        });

        // Authentication functions
        function showAuthSection() {
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('main-section').classList.add('hidden');
            document.getElementById('main-header').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('main-section').classList.remove('hidden');
            document.getElementById('main-header').classList.remove('hidden');
        }

        function showLoginForm() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('auth-title').textContent = 'Welcome Back';
            clearFormErrors();
        }

        function showRegisterForm() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
            document.getElementById('auth-title').textContent = 'Create Account';
            clearFormErrors();
        }

        function clearFormErrors() {
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            document.getElementById('auth-message').innerHTML = '';
        }

        async function login() {
            clearFormErrors();
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            // Validation
            let hasErrors = false;
            if (!email) {
                document.getElementById('login-email-error').textContent = 'Email is required';
                hasErrors = true;
            }
            if (!password) {
                document.getElementById('login-password-error').textContent = 'Password is required';
                hasErrors = true;
            }

            if (hasErrors) return;

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    
                    document.getElementById('user-email').textContent = currentUser.email;
                    document.getElementById('user-balance').textContent = currentUser.balance.toFixed(2);
                    
                    showMainApp();
                    loadDashboard();
                    loadStores();
                    loadCategories();
                } else {
                    document.getElementById('auth-message').innerHTML = 
                        `<div class="alert alert-error">${data.error}</div>`;
                }
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('auth-message').innerHTML = 
                    '<div class="alert alert-error">Login failed. Please try again.</div>';
            }
        }

        async function register() {
            clearFormErrors();
            
            const fullName = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const referralCode = document.getElementById('register-referral').value.trim();

            // Validation
            let hasErrors = false;
            if (!fullName) {
                document.getElementById('register-name-error').textContent = 'Full name is required';
                hasErrors = true;
            }
            if (!email) {
                document.getElementById('register-email-error').textContent = 'Email is required';
                hasErrors = true;
            }
            if (!password) {
                document.getElementById('register-password-error').textContent = 'Password is required';
                hasErrors = true;
            } else if (password.length < 6) {
                document.getElementById('register-password-error').textContent = 'Password must be at least 6 characters';
                hasErrors = true;
            }

            if (hasErrors) return;

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        fullName, 
                        email, 
                        password, 
                        referralCode: referralCode || null 
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('auth-message').innerHTML = 
                        `<div class="alert alert-success">
                            Account created successfully! Your referral code: <strong>${data.referralCode}</strong>
                            <br>Please login to continue.
                        </div>`;
                    
                    setTimeout(() => {
                        showLoginForm();
                        document.getElementById('login-email').value = email;
                    }, 2000);
                } else {
                    document.getElementById('auth-message').innerHTML = 
                        `<div class="alert alert-error">${data.error}</div>`;
                }
            } catch (error) {
                console.error('Registration error:', error);
                document.getElementById('auth-message').innerHTML = 
                    '<div class="alert alert-error">Registration failed. Please try again.</div>';
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            allStores = [];
            categories = [];
            showAuthSection();
        }

        // Dashboard functions
        async function loadDashboard() {
            if (!authToken) return;

            try {
                const response = await fetch('/api/dashboard', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Update dashboard
                    document.getElementById('dashboard-balance').textContent = data.user.balance.toFixed(2);
                    document.getElementById('dashboard-earned').textContent = data.user.totalEarned.toFixed(2);
                    document.getElementById('dashboard-stores').textContent = data.stats.stores_visited;
                    document.getElementById('dashboard-clicks').textContent = data.stats.total_clicks;
                    
                    // Update header balance
                    document.getElementById('user-balance').textContent = data.user.balance.toFixed(2);
                    
                    // Update recent activity
                    displayRecentActivity(data.recentClicks);
                }
            } catch (error) {
                console.error('Dashboard load error:', error);
            }
        }

        function displayRecentActivity(clicks) {
            const container = document.getElementById('recent-clicks');
            
            if (!clicks || clicks.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">No recent activity</p>';
                return;
            }

            container.innerHTML = clicks.map(click => `
                <div class="activity-item">
                    <img src="${click.logo_url}" alt="${click.store_name}" class="activity-logo" 
                         onerror="this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"30\" height=\"30\" viewBox=\"0 0 30 30\"><rect width=\"30\" height=\"30\" fill=\"%23e9ecef\"/><text x=\"15\" y=\"20\" text-anchor=\"middle\" fill=\"%23666\">S</text></svg>'">
                    <div class="activity-details">
                        <div>Visited <strong>${click.store_name}</strong></div>
                        <div class="activity-time">${formatDate(click.clicked_at)}</div>
                    </div>
                </div>
            `).join('');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) return 'Today';
            if (diffDays === 2) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            
            return date.toLocaleDateString();
        }

        // Store functions
        async function loadStores() {
            document.getElementById('stores-loading').classList.remove('hidden');
            
            try {
                const response = await fetch('/api/stores');
                
                if (response.ok) {
                    allStores = await response.json();
                    displayStores(allStores);
                } else {
                    console.error('Failed to load stores');
                }
            } catch (error) {
                console.error('Store load error:', error);
            } finally {
                document.getElementById('stores-loading').classList.add('hidden');
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch('/api/stores/categories');
                
                if (response.ok) {
                    categories = await response.json();
                    const select = document.getElementById('category-filter');
                    
                    // Clear existing options except "All Categories"
                    select.innerHTML = '<option value="all">All Categories</option>';
                    
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Categories load error:', error);
            }
        }

        function displayStores(stores) {
            const container = document.getElementById('stores-container');
            
            if (stores.length === 0) {
                container.innerHTML = '<p style="text-align: center; grid-column: 1/-1; color: #666;">No stores found</p>';
                return;
            }

            container.innerHTML = stores.map(store => `
                <div class="store-card">
                    <div class="store-header">
                        <img src="${store.logo_url}" alt="${store.name}" class="store-logo" 
                             onerror="this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"50\" height=\"50\" viewBox=\"0 0 50 50\"><rect width=\"50\" height=\"50\" fill=\"%23e9ecef\" rx=\"8\"/><text x=\"25\" y=\"30\" text-anchor=\"middle\" fill=\"%23666\" font-size=\"20\">${store.name.charAt(0)}</text></svg>'">
                        <div class="store-info">
                            <h3>${store.name}</h3>
                            <span class="store-category">${store.category}</span>
                        </div>
                    </div>
                    
                    <p class="store-description">${store.description || 'Discover great deals and earn cashback'}</p>
                    
                    <div class="cashback-info">
                        <div>
                            <div class="cashback-rate">${store.cashback_rate}% Cashback</div>
                            <div class="commission-rate">Commission: ${store.commission_rate}%</div>
                        </div>
                    </div>
                    
                    <button class="btn" style="width: 100%;" onclick="visitStore(${store.id}, '${store.affiliate_url}', '${store.name}')">
                        🛍️ Shop Now & Earn ₹${calculateEstimatedEarnings(store.cashback_rate)}
                    </button>
                </div>
            `).join('');
        }

        function calculateEstimatedEarnings(cashbackRate) {
            // Assume average purchase of ₹1000 for estimation
            const averagePurchase = 1000;
            const earnings = (averagePurchase * cashbackRate) / 100;
            return earnings.toFixed(0);
        }

        function filterStores() {
            const searchTerm = document.getElementById('store-search').value.toLowerCase();
            const selectedCategory = document.getElementById('category-filter').value;
            
            let filteredStores = allStores;
            
            // Filter by search term
            if (searchTerm) {
                filteredStores = filteredStores.filter(store => 
                    store.name.toLowerCase().includes(searchTerm) ||
                    store.description.toLowerCase().includes(searchTerm)
                );
            }
            
            // Filter by category
            if (selectedCategory && selectedCategory !== 'all') {
                filteredStores = filteredStores.filter(store => 
                    store.category === selectedCategory
                );
            }
            
            displayStores(filteredStores);
        }

        async function visitStore(storeId, affiliateUrl, storeName) {
            if (!authToken) {
                alert('Please login to earn cashback');
                return;
            }

            try {
                // Track the click
                const response = await fetch('/api/click', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ storeId })
                });

                const data = await response.json();

                if (response.ok) {
                    // Show success message
                    const message = document.createElement('div');
                    message.className = 'alert alert-success';
                    message.innerHTML = `
                        ✅ Click tracked! You'll earn <strong>${data.cashbackRate}</strong> cashback on purchases from ${storeName}.
                        <br>Redirecting to store...
                    `;
                    document.body.insertBefore(message, document.body.firstChild);

                    // Remove message after 3 seconds
                    setTimeout(() => message.remove(), 3000);

                    // Redirect to affiliate URL
                    setTimeout(() => {
                        window.open(data.affiliateUrl, '_blank');
                    }, 1000);

                    // Refresh dashboard
                    loadDashboard();
                } else {
                    console.error('Click tracking failed:', data.error);
                    // Still redirect even if tracking fails
                    window.open(affiliateUrl, '_blank');
                }
            } catch (error) {
                console.error('Visit store error:', error);
                // Fallback: still redirect to store
                window.open(affiliateUrl, '_blank');
            }
        }

        // Utility functions
        function showLoading() {
            document.getElementById('stores-loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('stores-loading').classList.add('hidden');
        }

        // Auto-refresh dashboard every 30 seconds
        setInterval(() => {
            if (authToken && !document.getElementById('main-section').classList.contains('hidden')) {
                loadDashboard();
            }
        }, 30000);
    </script>
</body>
</html>
